# Flutter Setup & Verification for MathAI Mobile

## 1. SDK Installation
```bash
# Clone Flutter stable
git clone https://github.com/flutter/flutter.git -b stable ~/flutter
# Add to PATH (put in ~/.bashrc for persistence)
export PATH="$PATH:$HOME/flutter/bin"
```

Add to `~/.bashrc` for future sessions:
```bash
echo 'export PATH="$PATH:$HOME/flutter/bin"' >> ~/.bashrc
source ~/.bashrc
```

## 2. Verify Installation
```bash
flutter --version
flutter doctor
```
You will likely see issues for Android SDK, Chrome, and Linux desktop toolchain initially.

## 3. Project Dependencies
From repository root:
```bash
cd mathai_mobile
flutter pub get
```

## 4. Run Tests
```bash
flutter test
```
All tests should pass (widget smoke + cache test).

## 5. Linux Desktop Support (WSL / Ubuntu)
Install required build packages:
```bash
sudo apt update
sudo apt install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
```
Re-run doctor:
```bash
flutter doctor
```
If using WSL without GUI, Linux desktop run may not display. Consider Android emulator instead.

## 6. Android Setup (Optional Mobile Execution)
Install Android Studio and SDK components (outside scope of this repo instructions):
1. Download Android Studio.
2. Install SDK + platform tools.
3. Accept licenses:
```bash
yes | sdkmanager --licenses
```
4. Configure Flutter:
```bash
flutter config --android-sdk /path/to/Android/Sdk
flutter doctor
```

### Headless CLI Setup (Alternative)
If you prefer not to install the full Android Studio UI on CI or server:
```bash
mkdir -p $HOME/android-sdk/cmdline-tools
cd $HOME/android-sdk
curl -LO https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
unzip commandlinetools-linux-9477386_latest.zip -d cmdline-tools
mv cmdline-tools/cmdline-tools cmdline-tools/tools
export ANDROID_HOME=$HOME/android-sdk
export PATH="$ANDROID_HOME/cmdline-tools/tools/bin:$ANDROID_HOME/platform-tools:$PATH"
sdkmanager --sdk_root=$ANDROID_HOME "platform-tools" "platforms;android-34" "build-tools;34.0.0"
yes | sdkmanager --licenses
flutter config --android-sdk $ANDROID_HOME
flutter doctor
```

### Building APK Locally
```bash
cd mathai_mobile
flutter build apk --debug
ls build/app/outputs/flutter-apk/
```

### Running on Emulator
```bash
flutter emulators --create --name mathai_emulator
flutter emulators --launch mathai_emulator
flutter devices  # ensure emulator listed
flutter run -d emulator-5554
```

## 7. Running the App
Linux (after toolchain & GUI available):
```bash
flutter run -d linux
```
To build without launching a window (e.g. headless/CI):
```bash
flutter build linux --debug
ls build/linux/x64/debug/bundle/
```
Android (after emulator/device ready):
```bash
flutter devices      # list
flutter emulators    # list emulators
flutter emulators --launch <name>
flutter run -d <device_id>
```

### Linux Desktop (WSL Considerations)
If you're using WSL without WSLg (older Windows 10) you'll need an X server (VcXsrv/X410) and set DISPLAY:
```bash
export DISPLAY=$(grep nameserver /etc/resolv.conf | awk '{print $2}'):0.0
```
Then run:
```bash
flutter run -d linux
```
With Windows 11 WSLg this usually works out-of-the-box (no manual DISPLAY export). If GUI isn't required, just build the bundle as shown above.

## 8. macOS & Windows (Scaffolded Platforms)
The project includes `macos/` and `windows/` directories generated by Flutter. Building must be done on the respective host OS.

### macOS
Prerequisites:
1. macOS host.
2. Xcode installed + command line tools.
3. Enable desktop: (usually already enabled) `flutter config --enable-macos-desktop`.
Build & run:
```bash
cd mathai_mobile
flutter pub get
flutter build macos --debug
flutter run -d macos
```
Signing: For distribution, configure signing in Xcode (Runner project) and consider `flutter build macos --release`.

### Windows
Prerequisites:
1. Windows 10/11 host.
2. Visual Studio 2022 with "Desktop development with C++" workload.
3. Enable desktop: `flutter config --enable-windows-desktop` (if not already).
Build & run (PowerShell or CMD):
```powershell
cd mathai_mobile
flutter pub get
flutter build windows --debug
flutter run -d windows
```
The build output appears under `build/windows/runner/`.

CI Note: Cross-building macOS/Windows from Linux is not supported; use dedicated runners.

## 9. Environment Override
Use a different backend host:
```bash
flutter run --dart-define=MATHAI_BASE_URL=https://your.backend
```

## 10. Common Issues
| Issue | Fix |
|-------|-----|
| Missing Android SDK | Install Android Studio, set sdk path with `flutter config` |
| Missing Linux toolchain | `sudo apt install clang cmake ninja-build pkg-config libgtk-3-dev` |
| Linux desktop blank under WSL | Ensure X server running or use WSLg; check `$DISPLAY` is set |
| shared_preferences MissingPlugin in tests | Ensure `SharedPreferences.setMockInitialValues({})` before usage |
| Unable to access backend from emulator | Use `10.0.2.2` for Android, ensure backend listens on 0.0.0.0:8000 |
| CORS errors | Add CORS middleware in FastAPI backend |
| APK build fails on CI | Ensure Java 17 + run `flutter pub get` before build |
| Emulator not starting on CI | Use macOS/Linux runners with KVM (advanced, not default) |

## 11. Next Enhancements
- CI workflow running `flutter test` + backend pytest.
- Add integration tests for API calls with mock server.
- Add release build steps (`flutter build apk`, `flutter build appbundle`).

---
Generated setup file to streamline Flutter onboarding.
